name: Auto Generate Full Sitemap

on:
  push:
    branches:
      - main
  schedule:
    - cron: '0 2 * * *'  # optional, setiap hari jam 2 UTC

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repo
      - uses: actions/checkout@v3

      # 2️⃣ Install dependencies
      - name: Install dependencies
        run: sudo apt-get install -y python3-bs4 python3-lxml python3-requests

      # 3️⃣ Generate sitemap by scanning all HTML files recursively
      - name: Generate sitemap
        run: |
          python3 << 'EOF'
          import os
          from bs4 import BeautifulSoup

          BASE_URL = "https://denmard123.github.io/Dye/"
          sitemap_file = "sitemap.xml"
          urls = set()

          # Fungsi scan HTML
          def scan_html(file_path, base_url):
              try:
                  with open(file_path, "r", encoding="utf-8") as f:
                      soup = BeautifulSoup(f, "lxml")
                  for a in soup.find_all("a", href=True):
                      href = a["href"].strip()
                      if href.startswith("#") or href.startswith("javascript:"):
                          continue
                      if href.startswith("http://") or href.startswith("https://"):
                          urls.add(href)
                      else:
                          full_url = os.path.join(base_url, href).replace("\\", "/")
                          urls.add(full_url)
              except Exception as e:
                  print(f"Error scanning {file_path}: {e}")

          # Scan semua HTML di root dan sub-folder
          for root, dirs, files in os.walk("."):
              for file in files:
                  if file.endswith(".html"):
                      rel_path = os.path.join(root, file)
                      scan_html(rel_path, BASE_URL)

          # Tambahkan homepage
          urls.add(BASE_URL)

          # Tulis sitemap.xml
          with open(sitemap_file, "w", encoding="utf-8") as f:
              f.write('<?xml version="1.0" encoding="UTF-8"?>\n')
              f.write('<urlset xmlns="https://www.sitemaps.org/schemas/sitemap/0.9">\n')
              for url in sorted(urls):
                  if "about.html" in url:
                      priority = "0.8"
                  elif "blog" in url:
                      priority = "0.7"
                  elif "HabitTracker" in url or "SssGame" in url:
                      priority = "0.9"
                  else:
                      priority = "0.6"
                  f.write(f"  <url><loc>{url}</loc><priority>{priority}</priority></url>\n")
              f.write('</urlset>\n')
          EOF

      # 4️⃣ Commit & Push sitemap
      - name: Commit & Push Sitemap
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add sitemap.xml
          git commit -m "Auto-update full sitemap" || echo "No changes to commit"
          git push https://x-access-token:${PAT_TOKEN}@github.com/Denmard123/Dye.git HEAD:main
